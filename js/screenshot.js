var Screenshot=function(){return{takeScreenshot:function(){self=this,chrome.tabs.captureVisibleTab(null,function(e){new Date,chrome.extension.getURL("screenshot.html");filename=$("#filename").val();var t=JSON.parse(localStorage.getItem("Screenshots"));if(null==t&&(t={}),""!=filename){var a=(e.replace(/^data:image\/[^;]/,"data:application/octet-stream"),document.createElement("a"));a.download=filename+".jpg",a.href=e;for(var n=1;null!=t[filename];)n++,filename+=n;t[filename]=e,Object.keys(t).length>2&&$("#"+buttons.screenshot).attr("disabled","disabled"),localStorage.setItem("Screenshots",JSON.stringify(t)),$("#filename").val(""),$.get("screenshotListItem.html",function(e){var t=$($(e)[0]).attr("data-screenshot-name",filename)[0];t=$(t).append(filename),$(".screenshot-group").append(t),self.initScreenshotEvents()})}})},downloadScreenshots:function(){var e=JSON.parse(localStorage.getItem("Screenshots"));console.log(e),jQuery.ajaxSetup({async:!1});for(var t in e){var a=e[t],n=document.createElement("a");n.download=t+".jpg",n.href=a,n.click()}jQuery.ajaxSetup({async:!0})},clearScreenshots:function(){localStorage.removeItem("Screenshots"),$(".screenshot-group").children().remove()},validateTakeScreenshot:function(){$("#filename").each(function(){selfData=$(this),(""==selfData.val()||void 0==selfData.val())&&$("#"+buttons.screenshot).attr("disabled","disabled"),selfData.keyup(function(){if(""==selfData.val()||void 0==selfData.val())$("#"+buttons.screenshot).attr("disabled","disabled");else{var e=selfData.val().substring(selfData.val().length-1,selfData.val().length);if(-1!=["\\","/",":","*","?","<",">","|"].indexOf(e))return void selfData.val(selfData.val().substring(0,selfData.val().length-1));var t=JSON.parse(localStorage.getItem("Screenshots"))||{};Object.keys(t).length>2?$("#"+buttons.screenshot).attr("disabled","disabled"):$("#"+buttons.screenshot).removeAttr("disabled")}})})},initScreenshotEvents:function(){this.validateTakeScreenshot(),$(".screenshot-edit").click(function(e){e.preventDefault(),localStorage.setItem("editImageIndex",$(this).parent().attr("data-screenshot-name")),chrome.tabs.query({currentWindow:!0,active:!0},function(e){chrome.tabs.create({url:"../html/edit.html",index:e[0].index+1,openerTabId:e[0].id})})}),$(".screenshot-save").click(function(e){e.preventDefault();var t=JSON.parse(localStorage.getItem("Screenshots")),a=$(this).parent().attr("data-screenshot-name"),n=t[a],s=document.createElement("a");s.download=a+".jpg",s.href=n,s.click()}),$(".screenshot-remove").click(function(e){e.preventDefault();var t=JSON.parse(localStorage.getItem("Screenshots")),a=$(this).parent().attr("data-screenshot-name");delete t[a],Object.keys(t).length>2||$("#"+buttons.screenshot).attr("disabled",!1),localStorage.setItem("Screenshots",JSON.stringify(t)),$(this).parent().remove()})}}};